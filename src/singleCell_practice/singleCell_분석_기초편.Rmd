---
title: "singleCell_분석_기초"
author: "yeji Bae"
date: "2023-10-10"
output: html_document
---

해당 스크립트는 "실전 단일세포 데이터 분석: 예제 코드와 데이터로 배우는 생물정보 분석 기술" 책에서 따라 할 수 있도록 제작된 실습 스크립트 '기초편' 입니다. 

현재 보고 계시는 코드는 제일 기본 코드이며, 조금 더 심화된 코드를 확인 하고 싶다면 singleCell_분석_고급편.Rmd 파일을 확인해주세요.

만약, 단일 세포 분석이 처음이시라면, 기초, 중급, 고급 스크립트를 하나씩 소화해 나가시길 추천합니다. 

각 코드블럭에 대한 자세한 설명은 언급되어 있는 챕터에 나와있는 설명들을 참고바랍니다. 

질문 사항이 있거나, 코드를 돌리는데 어려움이 있다면 github페이지에서 -> 'issue' 탭 -> 'New issue' 버튼을 클릭해서 작성해주시면 빠른 시일내에 답변드리겠습니다. 

**도협 박사님! 'Question' 이라고 적은 부분과 주석들을 자세히 읽고 피드백 부탁 드립니다.**
Question: R script or Rmd script? 

```{r setup, include=FALSE} 
# knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(echo = TRUE)
setwd("/Users/ybae/Desktop/YJ/singleCell_book/src/singleCell_practice/")
```

# 필요한 라이브러리 불러오기 
챕터 02-02 'R 패키지 설치 및 실행' 참고 
```{r}
library(Seurat)
library(dplyr)
```

# 챕터 05  "Seurat Object 만들기, 품질관리 및 필터링"
## 챕터 05-01 "Seurat Object 만들기"

[코드 5 - 1] 2가지 방법으로 Seurat 오브젝트 만들기 (Question - 책에서는 타이틀을 코드 블럭 아래에 두었는데 여기는 위? 아래? )
```{r}
# [1] h5 파일 이용하기
count_SRR13911909.h5 <- Read10X_h5("./singleCell/results/count_SRR13911909/outs/filtered_feature_bc_matrix.h5", use.names = TRUE, unique.features = TRUE)
SRR13911909.h5.sobj <- CreateSeuratObject(counts = count_SRR13911909.h5, project = "pbmc_alzheimer")

# [2] filtered_feature_bc_matrix folder 폴더 이용하기 
SRR13911909 <- Read10X(data.dir =  "./singleCell/results/count_SRR13911909/outs/filtered_feature_bc_matrix/" )
SRR13911909.sobj <- CreateSeuratObject(counts = SRR13911909, project = "pbmc_alzheimer")
```

[코드 5-1.1] 코드 시간 재기 
```{r}
# 코드가 얼마나 걸리는지 시간 재기 (예시). 이 때, 해당 코드 블럭을 한번에 실행시켜줘야 정확한 시간을 얻을 수 있습니다. 하이라이트 한 뒤 실행 시키면 한번에 실행 가능합니다. 
# [1] h5 파일 이용하기
start <- Sys.time() # 시작 시간 
count_SRR13911909.h5 <- Read10X_h5("./singleCell/results/count_SRR13911909/outs/filtered_feature_bc_matrix.h5", use.names = TRUE, unique.features = TRUE)
SRR13911909.h5.sobj <- CreateSeuratObject(counts = count_SRR13911909.h5, project = "pbmc_alzheimer")
print( Sys.time() - start ) # 현재 시간 – 시작 시간  = 총 걸린 시간

# [2] filtered_feature_bc_matrix folder 폴더 이용하기 
start <- Sys.time()
SRR13911909 <- Read10X(data.dir = "./singleCell/results/count_SRR13911909/outs/filtered_feature_bc_matrix/")
SRR13911909.sobj <- CreateSeuratObject(counts = pbmc_alzheimer.SRR13911909, project = "pbmc_alzheimer")
print( Sys.time() - start )
```


[코드 5 - 2] 모든 샘플을 Seurat 오브젝트로 변형하기
```{r}
# 각 샘플마다 raw matrix 를 Seurat object 로 생성하기
count_SRR13911909.h5 <- Read10X_h5("./filtered_feature_bc_matrix_SRR13911909.h5", use.names = TRUE, unique.features = TRUE)
SRR13911909.h5.sobj <- CreateSeuratObject(counts = count_SRR13911909.h5, project = "pbmc_alzheimer")

count_SRR13911910.h5 <- Read10X_h5("./filtered_feature_bc_matrix_SRR13911910.h5", use.names = TRUE, unique.features = TRUE)
SRR13911910.h5.sobj <- CreateSeuratObject(counts = count_SRR13911910.h5, project = "pbmc_alzheimer")

count_SRR13911911.h5 <- Read10X_h5("./filtered_feature_bc_matrix_SRR13911911.h5", use.names = TRUE, unique.features = TRUE)
SRR13911911.h5.sobj <- CreateSeuratObject(counts = count_SRR13911911.h5, project = "pbmc_alzheimer")

count_SRR13911912.h5 <- Read10X_h5("./filtered_feature_bc_matrix_SRR13911912.h5", use.names = TRUE, unique.features = TRUE)
SRR13911912.h5.sobj <- CreateSeuratObject(counts = count_SRR13911912.h5, project = "pbmc_alzheimer")

count_SRR13911913.h5 <- Read10X_h5("./filtered_feature_bc_matrix_SRR13911913.h5", use.names = TRUE, unique.features = TRUE)
SRR13911913.h5.sobj <- CreateSeuratObject(counts = count_SRR13911913.h5, project = "pbmc_alzheimer")

count_SRR13911914.h5 <- Read10X_h5("./filtered_feature_bc_matrix_SRR13911914.h5", use.names = TRUE, unique.features = TRUE)
SRR13911914.h5.sobj <- CreateSeuratObject(counts = count_SRR13911914.h5, project = "pbmc_alzheimer")
```

Seurat 오브젝트 둘러보기 
```{r}
# seurat object 크기 확인하기
SRR13911909.h5.sobj
dim(SRR13911909.h5.sobj) # feature (gene) x cell 
colnames(SRR13911909.h5.sobj)[1:10] # cell barcode
rownames(SRR13911909.h5.sobj)[1:10] # feature (gene) name 

## 메타데이터 
SRR13911909.h5.sobj[[]] 
SRR13911909.h5.sobj@meta.data 

## Assay
SRR13911909.h5.sobj@assays$RNA
SRR13911909.h5.sobj@assays$RNA$counts

## others 
SRR13911909.h5.sobj@ # @뒤에서 'tab'을 눌러서 어떤 데이터를 불러 올 수 있는지 확인해 보세요. 
```

## 챕터 05-02 '품질관리 (QC) 및 필터링'

[코드 5-3] 미토콘드리아 비율 구하기
```{r}
# 각 샘플마다 미토콘드리아 비율 구하기 
SRR13911909.h5.sobj[["percent.mt"]] <- PercentageFeatureSet(SRR13911909.h5.sobj, pattern = "^MT-")
SRR13911910.h5.sobj[["percent.mt"]] <- PercentageFeatureSet(SRR13911910.h5.sobj, pattern = "^MT-")
SRR13911911.h5.sobj[["percent.mt"]] <- PercentageFeatureSet(SRR13911911.h5.sobj, pattern = "^MT-")
SRR13911912.h5.sobj[["percent.mt"]] <- PercentageFeatureSet(SRR13911912.h5.sobj, pattern = "^MT-")
SRR13911913.h5.sobj[["percent.mt"]] <- PercentageFeatureSet(SRR13911913.h5.sobj, pattern = "^MT-")
SRR13911914.h5.sobj[["percent.mt"]] <- PercentageFeatureSet(SRR13911914.h5.sobj, pattern = "^MT-")
```

[코드 5-4,5] QC plots 시각화 하기 
```{r}
# Violoin plot 
VlnPlot(SRR13911909.h5.sobj, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
VlnPlot(SRR13911910.h5.sobj, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
VlnPlot(SRR13911911.h5.sobj, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
VlnPlot(SRR13911912.h5.sobj, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
VlnPlot(SRR13911913.h5.sobj, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
VlnPlot(SRR13911914.h5.sobj, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

# Scatter featrue plot [1] ncount x nfeature [2] ncount vs percent.mt  
FeatureScatter(SRR13911909.h5.sobj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") # [1]
FeatureScatter(SRR13911909.h5.sobj, feature1 = "nCount_RNA", feature2 = "percent.mt")   # [2]
FeatureScatter(SRR13911910.h5.sobj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
FeatureScatter(SRR13911910.h5.sobj, feature1 = "nCount_RNA", feature2 = "percent.mt")
FeatureScatter(SRR13911911.h5.sobj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
FeatureScatter(SRR13911911.h5.sobj, feature1 = "nCount_RNA", feature2 = "percent.mt")
FeatureScatter(SRR13911912.h5.sobj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
FeatureScatter(SRR13911912.h5.sobj, feature1 = "nCount_RNA", feature2 = "percent.mt")
FeatureScatter(SRR13911913.h5.sobj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
FeatureScatter(SRR13911913.h5.sobj, feature1 = "nCount_RNA", feature2 = "percent.mt")
FeatureScatter(SRR13911914.h5.sobj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
FeatureScatter(SRR13911914.h5.sobj, feature1 = "nCount_RNA", feature2 = "percent.mt")
```

[코드 5-6] 위의 플롯들을 이용해서 필터링 하기 
```{r}
# 필터링 
SRR13911909.h5.sobj <- subset(SRR13911909.h5.sobj, subset = nFeature_RNA > 200 & nFeature_RNA < 3000 & percent.mt < 10)  
SRR13911910.h5.sobj <- subset(SRR13911910.h5.sobj, subset = nFeature_RNA > 200 & nFeature_RNA < 3000 & percent.mt < 10)
SRR13911911.h5.sobj <- subset(SRR13911911.h5.sobj, subset = nFeature_RNA > 200 & nFeature_RNA < 3000 & percent.mt < 10)
SRR13911912.h5.sobj <- subset(SRR13911912.h5.sobj, subset = nFeature_RNA > 200 & nFeature_RNA < 3000 & percent.mt < 10)
SRR13911913.h5.sobj <- subset(SRR13911913.h5.sobj, subset = nFeature_RNA > 200 & nFeature_RNA < 3000 & percent.mt < 10)
SRR13911914.h5.sobj <- subset(SRR13911914.h5.sobj, subset = nFeature_RNA > 200 & nFeature_RNA < 3000 & percent.mt < 10)
```

[코드 5-7] 필터링 된 데이터의 QC 플롯 그려보기 
```{r, fig.width = 10}
# 예시 - SRR13911909.h5.sobj
VlnPlot(SRR13911909.h5.sobj, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
FeatureScatter(SRR13911909.h5.sobj, feature1 = "nCount_RNA", feature2 = "percent.mt")
FeatureScatter(SRR13911909.h5.sobj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")

# Task: 다른 샘플들의 QC 플롯들도 그려보세요. (아래 테스트 삭제 해야함)
# count_SRR13911909.h5 <- Read10X_h5("./filtered_feature_bc_matrix_SRR13911909.h5", use.names = TRUE, unique.features = TRUE)
# SRR13911909.h5.sobj <- CreateSeuratObject(counts = count_SRR13911909.h5, project = "pbmc_alzheimer", min.cells = 3, min.features = 200)
# SRR13911909.h5.sobj[["percent.mt"]] <- PercentageFeatureSet(SRR13911909.h5.sobj, pattern = "^MT-")
# SRR13911909.h5.sobj <- subset(SRR13911909.h5.sobj, subset = nFeature_RNA > 200 & nFeature_RNA < 3000 & percent.mt < 10)  
# VlnPlot(SRR13911909.h5.sobj, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
# FeatureScatter(SRR13911909.h5.sobj, feature1 = "nCount_RNA", feature2 = "percent.mt")
# FeatureScatter(SRR13911909.h5.sobj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
```



# Chapter 06 "정규화 및 배치 교정"
= Normalization + Integration + Dimension reduction

Question - 해당 부분 보완 가능하면 부탁드립니다 

방법 1: 각 샘플을 정규화 한 후, 합치기 
방법 2 : 모든 샘플을 합친 후, 한번에 정규화 하기 

## Log normalization
챕터 06-01-로그정규화 이용 

- *NormalizeData()*: https://satijalab.org/seurat/reference/normalizedata 
- *merge()*: https://satijalab.org/seurat/articles/seurat5_merge_vignette#merging-more-than-two-seurat-objects
```{r}
# 방법 1 # 
# 샘플 별 정규화 진행하기 
SRR13911909.h5.sobj_norm <- NormalizeData(SRR13911909.h5.sobj) 
SRR13911910.h5.sobj_norm <- NormalizeData(SRR13911910.h5.sobj)
SRR13911911.h5.sobj_norm <- NormalizeData(SRR13911911.h5.sobj)
SRR13911912.h5.sobj_norm <- NormalizeData(SRR13911912.h5.sobj)
SRR13911913.h5.sobj_norm <- NormalizeData(SRR13911913.h5.sobj)
SRR13911914.h5.sobj_norm <- NormalizeData(SRR13911914.h5.sobj)

# 정규환 된 샘플 별 seurat object들 합쳐주기 
pbmc_alzheimer_Log_1 <- merge(SRR13911909.h5.sobj_norm, 
                              y = c(SRR13911910.h5.sobj_norm,SRR13911911.h5.sobj_norm,SRR13911912.h5.sobj_norm,SRR13911913.h5.sobj_norm,SRR13911914.h5.sobj_norm),
                              add.cell.ids = c("SRR13911909", "SRR13911910", "SRR13911911", "SRR13911912", "SRR13911913", "SRR13911914"), 
                              project = "pbmc_alzheimer", 
                              merge.data = TRUE)
```

```{r}
# 방법 2 # 
# 각 seurat object 들 합지기 
pbmc_alzheimer_2 <- merge(SRR13911909.h5.sobj, y = c(SRR13911910.h5.sobj, SRR13911911.h5.sobj,SRR13911912.h5.sobj,SRR13911913.h5.sobj,SRR13911914.h5.sobj), add.cell.ids = c("SRR13911909", "SRR13911910", "SRR13911911", "SRR13911912", "SRR13911913", "SRR13911914"), project = "pbmc_alzheimer")

# 한번에 로그정규화 진행하기
pbmc_alzheimer_Log_2 <- NormalizeData(pbmc_alzheimer_2)
```
Question - Log normalization Integration? 


## SCTransform
챕터 06-01-SCTranfrom정규화 이용 
"https://satijalab.org/seurat/articles/sctransform_vignette" 에서 더 자세한 내용을 확인 할 수 있습니다. 

TODO: SCTransform v1 vs v2 ? 
  
*SCTransform()*: https://satijalab.org/seurat/reference/sctransform 
[방법 1]
```{r}
# 방법 1 # 
# 샘플 별 정규화 진행하기 
SRR13911909.h5.sobj_SCT <- SCTransform(SRR13911909.h5.sobj, verbose = FALSE) %>%
  RunPCA(npcs = 30, verbose = FALSE)
SRR13911910.h5.sobj_SCT <- SCTransform(SRR13911910.h5.sobj, verbose = FALSE) %>%
    RunPCA(npcs = 30, verbose = FALSE)
SRR13911911.h5.sobj_SCT <- SCTransform(SRR13911911.h5.sobj, verbose = FALSE) %>%
    RunPCA(npcs = 30, verbose = FALSE)
SRR13911912.h5.sobj_SCT <- SCTransform(SRR13911912.h5.sobj, verbose = FALSE) %>%
    RunPCA(npcs = 30, verbose = FALSE)
SRR13911913.h5.sobj_SCT <- SCTransform(SRR13911913.h5.sobj, verbose = FALSE) %>%
    RunPCA(npcs = 30, verbose = FALSE)
SRR13911914.h5.sobj_SCT <- SCTransform(SRR13911914.h5.sobj, verbose = FALSE) %>%
    RunPCA(npcs = 30, verbose = FALSE)

# 여러 seurat object 를 하나의 리스트로 묶기 
pbmc_alzheimer_SCT.list <- list(SRR13911909.h5.sobj_SCT = SRR13911909.h5.sobj_SCT, SRR13911910.h5.sobj_SCT = SRR13911910.h5.sobj_SCT,
                  SRR13911911.h5.sobj_SCT = SRR13911911.h5.sobj_SCT, SRR13911912.h5.sobj_SCT = SRR13911912.h5.sobj_SCT,
                  SRR13911913.h5.sobj_SCT = SRR13911913.h5.sobj_SCT , SRR13911914.h5.sobj_SCT = SRR13911914.h5.sobj_SCT)
saveRDS(pbmc_alzheimer_SCT.list, "./rds/pbmc_alzheimer_SCT.list.rds")
## 데이터가 큰 단일 세포를 분석할 때는, 오래 걸리는 함수를 돌린 후 나온 결과를 rds 파일 형태로 저장합니다.
## 이는 다음에 이어서 분석을 진행할때 처음부터 다시 돌릴 필요 없이, 저장해 둔 rds 파일을 불러와 진행시키기 위함입니다. 

# 정규화 된 seurat object 합치기 
features <- SelectIntegrationFeatures(object.list = pbmc_alzheimer_SCT.list, nfeatures = 3000) #Question: 2000 or 3000? 
pbmc_alzheimer_SCT.list <- PrepSCTIntegration(object.list = pbmc_alzheimer_SCT.list, anchor.features = features)

# 샘플 간의 앵커 찾기
pbmc_alzheimer_SCT.anchors <- FindIntegrationAnchors(object.list = pbmc_alzheimer_SCT.list, normalization.method = "SCT", anchor.features = features) # its name is samples.anchor
# saveRDS(pbmc_alzheimer_SCT.anchors, "./rds/pbmc_alzheimer_SCT.anchors.rds")
pbmc_alzheimer_SCT.combined <- IntegrateData(anchorset = pbmc_alzheimer_SCT.anchors, normalization.method = "SCT") # 메모리가 부족하면 (64GB 미만) 터질 수 있습니다.
# saveRDS(pbmc_alzheimer_SCT.combined, "./rds/sobj_SCT_merged_method_1.rds")
```

[방법 2]
```{r}
# 방법 2 # 
pbmc_alzheimer_2 <- merge(SRR13911909.h5.sobj, y = c(SRR13911910.h5.sobj, SRR13911911.h5.sobj,SRR13911912.h5.sobj,SRR13911913.h5.sobj,SRR13911914.h5.sobj), add.cell.ids = c("SRR13911909", "SRR13911910", "SRR13911911", "SRR13911912", "SRR13911913", "SRR13911914"), project = "pbmc_alzheimer")
# saveRDS(pbmc_alzheimer_2, "./rds/pbmc_alzheimer_2.rds")

pbmc_alzheimer_2_SCT <- SCTransform(pbmc_alzheimer_2, verbose = FALSE) 
```

우리는 ___ 방법으로 진행하도록 하겠습니다. 이유는?  

# 07 "차원 축소 및 클러스터링" 
## TODO: 이름 맞춰주기 방법 1 이랑 2랑 중에서  
[방법 1] 이어서 
```{r}
# sobj_SCT_merged_method_1 <- readRDS("./rds/sobj_SCT_merged_method_1.rds")
sobj_SCT_merged_method_1 <- RunPCA(sobj_SCT_merged_method_1, verbose = FALSE)
sobj_SCT_merged_method_1 <- RunUMAP(sobj_SCT_merged_method_1, reduction = "pca", dims = 1:20, verbose = FALSE)
sobj_SCT_merged_method_1 <- FindNeighbors(sobj_SCT_merged_method_1, reduction = "pca", dims = 1:20)
sobj_SCT_merged_method_1 <- FindClusters(sobj_SCT_merged_method_1, resolution = c(0.1,0.3, 0.5))
```

```{r, fig.width = 15}
# visualization
Idents(sobj_SCT_merged_method_1) <- "integrated_snn_res.0.1"
DimPlot(sobj_SCT_merged_method_1, label = T, reduction = "umap")

Idents(sobj_SCT_merged_method_1) <- "integrated_snn_res.0.3"
DimPlot(sobj_SCT_merged_method_1, label = T, reduction = "umap")

Idents(sobj_SCT_merged_method_1) <- "integrated_snn_res.0.5"
DimPlot(sobj_SCT_merged_method_1, label = T, reduction = "umap")
```

```{r}
 # TSNE
```



[방법 2] 이어서 
```{r}
pbmc_alzheimer_2_SCT <- RunPCA(pbmc_alzheimer_2_SCT, verbose = FALSE)
pbmc_alzheimer_2_SCT <- RunUMAP(pbmc_alzheimer_2_SCT, reduction = "pca", dims = 1:30, verbose = FALSE)
pbmc_alzheimer_2_SCT <- FindNeighbors(pbmc_alzheimer_2_SCT, reduction = "pca", dims = 1:30)
pbmc_alzheimer_2_SCT <- FindClusters(pbmc_alzheimer_2_SCT, resolution = 0.3)

# 혹은 다음과 같이 한번에 실행 가능합니다. 
pbmc_alzheimer_2_SCT <- RunPCA(pbmc_alzheimer_2_SCT, npcs = 30, verbose = FALSE) %>% # 메모리가 부족하면 (64GB 미만) 터질 수 있습니다.
                            RunUMAP(reduction = "pca", dims = 1:30, verbose = FALSE) %>%
                            FindNeighbors(reduction = "pca", dims = 1:30, verbose = FALSE) %>%
                            FindClusters(resolution = 0.7, verbose = FALSE)  #  vst.flavor = "v2", 
# saveRDS(pbmc_alzheimer_2_SCT, "./rds/pbmc_alzheimer_2_SCT.rds")
```

UMAP


# Finding DE features 
```{r}

```


# Annotation
챕터 08

1. marker features 구하고 -> 알려진 cell type specific gene 이용하기 
```{r}


```



2. public reference 이용하기 

- HumanPrimaryCellAtlasData
- MonacoImmuneData


```{r}
# install.packages("BiocManager")
```

HumanPrimaryCellAtlasData
```{r}
# Loading reference data with Ensembl annotations.
# BiocManager::install("celldex")
library(celldex)
# devtools::install_version("dbplyr", version = "2.3.4") # https://stackoverflow.com/questions/77370659/error-failed-to-collect-lazy-table-caused-by-error-in-db-collect-using\
# library(dbplyr)
ref.data <- HumanPrimaryCellAtlasData(ensembl=F)

## singeR 
# devtools::install_github('dviraran/SingleR')
library(SingleR)
library(Seurat)
sobj_SCE <- as.SingleCellExperiment(sobj_SCT_merged_method_1_clustered, assay="SCT")
# ref_SCE <- as.SingleCellExperiment(ref.data, assay="SCT") # not work for both RNA, SCT
# invalid class “Seurat” object: 1: all cells in graphs must be present in the Seurat object
results <- SingleR(test = sobj_SCE, ref = ref.data, labels = ref.data$label.main) 
# write.csv(results, "./sobj_SCT_merged_method_1_clustered_singleR.csv")
```



```{r, fig.width= 15}
sobj_SCT_merged_method_1_clustered$singleR_label <- results$labels
sobj_SCT_merged_method_1_clustered$singleR_pruned_label <- results$pruned.labels
Idents(sobj_SCT_merged_method_1_clustered) <- sobj_SCT_merged_method_1_clustered$singleR_pruned_label # or singleR_label
Idents(sobj_SCT_merged_method_1_clustered) <- sobj_SCT_merged_method_1_clustered$integrated_snn_res.0.3 # or singleR_label
DimPlot(sobj_SCT_merged_method_1_clustered, label = T, reduction = "umap")

## 3D UMAP 
```



```{r, fig.width = 15}
# 2023.11.29
sobj_SCE <- as.SingleCellExperiment(sobj_SCT_merged_method_1, assay="SCT")
results <- SingleR(test = sobj_SCE, ref = ref.data, labels = ref.data$label.main) 
sobj_SCT_merged_method_1$singleR_label <- results$labels
sobj_SCT_merged_method_1$singleR_pruned_label <- results$pruned.labels
Idents(sobj_SCT_merged_method_1) <- sobj_SCT_merged_method_1$singleR_pruned_label # or singleR_label
DimPlot(sobj_SCT_merged_method_1, label = T, reduction = "umap")
```

MonacoImmuneData
```{r, fig.width=15}
library(celldex)
library(SingleR)
ref.data <- celldex::MonacoImmuneData(ensembl=F)
ref.data

# singleR 이용해서 
sobj_SCE <- as.SingleCellExperiment(sobj_SCT_merged_method_1, assay="SCT")
results <- SingleR(test = sobj_SCE, ref = ref.data, labels = ref.data$label.main) 


sobj_SCT_merged_method_1$MonacoImmuneData_main <- results$labels
sobj_SCT_merged_method_1$MonacoImmuneData_pruned <- results$pruned.labels
Idents(sobj_SCT_merged_method_1) <- sobj_SCT_merged_method_1$MonacoImmuneData_pruned # or singleR_label 
DimPlot(sobj_SCT_merged_method_1, label = T, reduction = "umap") 

Idents(sobj_SCT_merged_method_1) <- sobj_SCT_merged_method_1$MonacoImmuneData_main # or singleR_label 
DimPlot(sobj_SCT_merged_method_1, label = T, reduction = "umap") 

```



scType
```{r}
# sctype() 오 근데 이거 python 였던것 같은데 아닌가? -> reticulate 까지 언급하면 너무 많을것같...
```




```{r}
# library(msm_fit)
```





